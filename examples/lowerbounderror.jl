using Boscia
using FrankWolfe
using Test
using SCIP
# using Statistics
using LinearAlgebra
using Distributions
import MathOptInterface
const MOI = MathOptInterface
using StableRNGs

println("\nThere is a error here")

# Poisson sparse regression

# min_{w, b, z} ∑_i exp(w x_i + b) - y_i (w x_i + b) + α norm(w)^2
# s.t. -N z_i <= w_i <= N z_i
# b ∈ [-N, N]
# ∑ z_i <= k 
# z_i ∈ {0,1} for i = 1,..,p

# y_i    - data points, poisson distributed 
# X_i, b - coefficient for the linear estimation of the expected value of y_i
# w_i    - continuous variables
# z_i    - binary variables s.t. z_i = 0 => w_i = 0
# k      - max number of non zero entries in w

# In a poisson regression, we want to model count data.
# It is assumed that y_i is poisson distributed and that the log 
# of its expected value can be computed linearly.

n = 20
p = n

# underlying true weights
const ws = [0.0, 0.7389571887619597, 0.0, 0.2968095071647865, 0.0, 0.0, 0.0, 0.367063531727885, 0.5531311318642305, 0.03572183008466867, 0.0, 0.0, 0.0, 0.9259473279284507, 0.0, 0.0, 0.0, 0.7413973868700641, 0.0, 0.0]
# set 50 entries to 0
const bs = 0.8256772209740846
const Xs = [-0.2277645376821327 0.06976513437065454 -1.4993197344621756 -0.7670466373068924 0.6080597827699987 0.06779258564919541 -1.1930192870638283 -0.4436144382177731 -0.058331716510289795 -0.6666414498260131 0.42110904741427607 -0.3631569335085509 -0.27197758908210473 1.007131863094319 -1.2175190711620452 -0.37775827441643506 1.2193473519835196 0.5784794732236553 -0.9434902399240405 0.0017262449524264526; 0.6927426650614565 0.418363774913379 0.017379725396667926 -0.20019540626152493 -1.0792393338110893 -1.2339346650376142 -1.8389857527838223 -1.311911458486018 0.961200184404708 -0.7323547187083631 -0.6755925895363671 -1.3065466990972665 1.4285387029853014 2.3072634530334115 -0.3359314794967884 -0.8487542304053715 -0.5896762131434754 0.23322677889673665 1.7797561945424945 0.5564834328618871; -0.42463864516810984 -0.014294899780722193 0.407250354857115 1.9749526460464084 0.27215815079104955 -0.902800523028085 -0.021529503178129832 -0.18105725510491738 0.9659640382996106 -1.7061684737368834 -0.23185812515746987 0.07430399167881804 0.5311333099486073 0.9379166915936192 1.48383628349281 -1.0793032258470747 1.3107733793933818 -0.17186621246427564 0.2809886920848296 -0.9647760384971846; 0.49368056072893635 1.658168340023242 -0.024568736240875754 1.6050479621281035 1.2127145381734508 0.4701667015981638 0.4298892774802881 -0.16159538854052355 -0.6895528576541946 -1.0208875981017282 1.0592170250815434 0.3207330814601813 0.24696407632563838 -1.2164145699124835 0.3085510359086679 -2.344758204072695 -1.1215739560880502 -1.122380000642277 -0.9397231512419543 0.6206595597121873; 0.2132461398261648 -0.12135743117820574 -1.5755522431930498 0.8990628174824337 0.45131787306415116 -0.8122865319420587 0.38928925582564217 0.16707433919630643 -0.21265821598666948 0.23573090348167564 0.6569472945379197 1.7356094363088101 -0.9598389646742566 -0.607406779987276 1.0591067045580371 0.6949736113878364 0.22737758219796922 -1.3113899910034912 1.4532318125364878 -0.28122215191705713; -0.8340595129044759 0.0328824064147447 -1.4556014585710377 2.3729272964525596 0.27636581841587304 0.943411459503949 0.42708709401314443 1.3019989950479016 -0.6197823312296715 -1.6172487029629192 0.15253321458374006 0.32715432083170837 -1.1190124419895355 -0.36101548920094345 0.31925493989878007 -1.352628423618677 1.397787674118964 -0.516587905862178 1.5184689416391406 -1.0038490875559396; -0.6974741347290584 -0.18039284725697907 0.5392901640190386 -1.4845157625834369 0.9557297386163452 -0.10640978267543524 0.8964090145031446 0.33712440972753166 -0.13166435628604867 1.3755638352388546 1.2869723091462595 0.4137552234882175 1.101665694936603 0.39362157710021084 -0.18433654159142204 0.7523358526087632 -0.629614879710578 -0.8903822396745842 -0.28669980225848263 -0.18557714826059; 0.202766347609599 0.9294265399380636 0.9069060953359949 0.01165904459643932 -1.45390741792685 0.009274539642662278 -0.07117154542305021 0.1918769003682684 1.6807356032192624 -0.5236736772595508 0.04570750934822519 1.7157041305321363 -0.1671900529403163 -1.3631234511786796 -0.041396505722660376 1.7050553971282352 -1.765805996736592 -1.1312935394667964 0.011361738216215125 0.5421920081265994; -1.429358273816044 1.0441397366596976 0.7393828959065744 0.9699756238878205 0.45473780144894116 0.671279265795496 1.3320233464623665 -0.8856801922420383 -1.8404509171641943 0.39447248349405223 -2.222782644089761 0.9662132253282085 1.157509665319032 -0.23441152800245463 -0.707662182106351 0.22661105616411034 -0.5269927822332515 0.49809825691513404 -1.0474633465677827 -8.631268779384494e-6; 2.0239920361664967 -0.1967847012418412 0.551145918513139 -0.4698198105184941 1.1867915663588198 0.46724027573846133 -1.7550096542539908 -0.14928918335269709 -0.824617161984791 0.10021349995920652 -0.2978308475665611 -1.3017525899216917 1.026504228671464 0.035560833067793965 0.2496106345247017 -1.67806135394501 0.557488493029964 0.26451117269799296 -1.5447953007763828 0.19859560759246436; -0.4572575564343356 -1.8817718630731848 -1.781751361805051 0.14667342449206688 0.11642690644638601 0.13457951920335487 1.4188841005561426 1.1942247272026392 -1.9877445215959593 -2.0311878685140496 0.36593113442760783 -1.0435364458858756 -0.2790801270520736 0.27774614035211465 -0.23400868057601473 -1.160434804560833 0.41132416218682366 0.30778639030079485 1.2654440211916262 -0.5004009942138158; 0.8518490690533006 0.5314554645361472 -0.5237842952817967 -1.5217040081222128 -0.5541766964737119 1.0683514577973086 0.7421024051152928 1.7484522090313097 -0.6047332192950735 0.03344207943998812 -2.1195501190683577 -0.3901201242452559 0.19085716796291485 -1.6323722935099385 -0.07791795472001516 -0.23258608837748276 0.6303650253969877 -1.4275543178965724 1.0562711516636614 0.2605458592614343; -0.3019818100637438 0.10277063740153385 0.17506385124594515 0.22895056580800513 1.3425576865024142 0.3800579438707285 -0.7207075156593544 -1.7843180557998182 -0.21047384958900717 1.1703191020693098 0.3990086648947933 1.9833027372320684 -0.3636932479865085 -0.7631505064144819 -0.336945111457166 -0.7289595491875925 -1.0155973248460146 0.6013472697349177 0.44095634786366134 -1.2759886672326715; -0.26772222674952617 0.8331839742961344 -1.9120364808928334 -0.9221347191793674 -1.6138079607732292 -0.04969026074265553 -0.729084471457933 0.7891344324877271 0.6168873025376862 -1.5738694045126516 -0.03328050226812675 -0.3088582424399339 1.057057427681752 -0.6182061619789447 0.8154141960425743 0.1751693324189009 1.9203521543453597 0.5935689551270877 1.8064037542094646 0.3869588796917123; -1.3705526051754384 -1.043470903951252 -0.14533225790386461 -1.9773497799041413 -1.2118888717345266 -0.34267613557076565 -0.6062281248809283 -0.9833951290999743 -0.7150072251548167 0.36457011039082743 0.31685748824837945 -1.2675079139766678 -1.04781144967145 -1.2741745787157237 -1.4148171162193894 0.11785421331069319 0.2428687966956758 -0.127920942702112 1.2297561434152708 0.5380357574032063; -0.13149579571665856 -0.19840133672495236 0.2736889619228289 -2.2352999451192757 -1.8145998919095714 -0.6956575634469585 -0.578693883211751 0.8740391644050592 -0.042695702318810716 -1.057114064728932 -1.479475058304875 -0.2876033693161655 0.7484429910538297 -0.3635768307480802 -2.767776189903654 -0.5599460281492109 -0.2073339739663438 -0.5973848752580454 -0.7523564570437046 -0.9658297198213889; -0.13298858696799265 0.8069338009818384 0.2506049776131092 0.347568012818373 0.606965325531829 -0.6830544804643675 0.5680975940140145 -0.29061602446868545 -0.9127421654935218 -0.9600083559030351 0.6538631326724408 -0.4581673287760643 -1.9433384065303585 -0.9550555975527127 -0.17033970224713854 0.6738338307802957 -1.0595227224371528 0.5929634158971988 1.5309513378018789 1.7737995972551988; 0.9753069139113901 1.7446395505941943 -1.09688599301813 -0.8593772758123324 -0.31618581220755804 0.16079492347090876 -1.1922856925640104 0.915296379384967 -2.256929817742751 -0.16588530129380372 0.34376839891632105 -0.23031554528080733 0.06476869199780744 -0.7009311636212894 -0.2873382991319882 0.6847949527517845 0.8240898964531769 0.9925678886550466 -0.6441065026574728 0.8004958961895104; -0.9626449745679658 0.375328568929281 0.4300335488580367 1.2769764361580176 -0.03644683730885551 -1.0510088660232662 -0.23292674564651852 -0.3474557749323965 -1.0614885560267235 0.6499150725232412 -0.02967149299684394 0.2725686989606745 1.2477891653001776 -0.5117382631874362 1.5209528259804634 0.5482286634984505 -1.7333690205639016 2.059609735792862 0.9702858926144007 -0.2632730854438805; -0.1080332840533848 0.19574752288024727 0.6555939224289703 0.39507715723789005 -1.20957627602734 0.035356411064950806 -1.2975993282557938 0.3965090377454953 -0.6283792050929495 -1.8052729054206456 0.19500695381590183 -1.9286077266270933 1.0610853435370673 -2.449504384642241 -0.7818661383309734 -0.4961124789250371 -0.2688774553031001 -0.3417794175016051 0.3280900731661072 -1.255853234256979]
const ys = [5, 25, 16, 0, 1, 3, 1, 1, 2, 1, 0, 1, 1, 7, 1, 0, 2, 2, 8, 1]
Ns = 0.10

# TODO: document better

@testset "Sparse poisson regression" begin
    k = 10
    o = SCIP.Optimizer()
    MOI.set(o, MOI.Silent(), true)
    MOI.empty!(o)
    w = MOI.add_variables(o, p)
    z = MOI.add_variables(o, p)
    b = MOI.add_variable(o)
    for i in 1:p
        MOI.add_constraint(o, z[i], MOI.GreaterThan(0.0))
        MOI.add_constraint(o, z[i], MOI.LessThan(1.0))
        MOI.add_constraint(o, z[i], MOI.ZeroOne())
    end
    for i in 1:p
        MOI.add_constraint(o, Ns * z[i] + w[i], MOI.GreaterThan(0.0))
        MOI.add_constraint(o, -Ns * z[i] + w[i], MOI.LessThan(0.0))
        # Indicator: z[i] = 1 => -N <= w[i] <= N
        #=gl = MOI.VectorAffineFunction(
            [   MOI.VectorAffineTerm(1, MOI.ScalarAffineTerm(1.0, z[i])),
                MOI.VectorAffineTerm(2, MOI.ScalarAffineTerm(1.0, w[i])),],
            [0.0, 0.0], )
        gg = MOI.VectorAffineFunction(
            [   MOI.VectorAffineTerm(1, MOI.ScalarAffineTerm(1.0, z[i])),
                MOI.VectorAffineTerm(2, MOI.ScalarAffineTerm(-1.0, w[i])),],
            [0.0, 0.0], )
        MOI.add_constraint(o, gl, MOI.Indicator{MOI.ACTIVATE_ON_ONE}(MOI.LessThan(Ns)))
        MOI.add_constraint(o, gg, MOI.Indicator{MOI.ACTIVATE_ON_ONE}(MOI.LessThan(-Ns))) =#
    end
    MOI.add_constraint(o, sum(z, init=0.0), MOI.LessThan(1.0 * k))
    MOI.add_constraint(o, sum(z, init=0.0), MOI.GreaterThan(1.0))
    MOI.add_constraint(o, b, MOI.LessThan(Ns))
    MOI.add_constraint(o, b, MOI.GreaterThan(-Ns))
    blmo = Boscia.MathOptBLMO(o)

    α = 1.3
    function f(θ)
        w = @view(θ[1:p])
        b = θ[end]
        s = sum(1:n) do i
            a = dot(w, Xs[:, i]) + b
            return 1 / n * (exp(a) - ys[i] * a)
        end
        return s + α * norm(w)^2
    end
    function grad!(storage, θ)
        w = @view(θ[1:p])
        b = θ[end]
        storage[1:p] .= 2α .* w
        storage[p+1:2p] .= 0
        storage[end] = 0
        for i in 1:n
            xi = @view(Xs[:, i])
            a = dot(w, xi) + b
            storage[1:p] .+= 1 / n * xi * exp(a)
            storage[1:p] .-= 1 / n * ys[i] * xi
            storage[end] += 1 / n * (exp(a) - ys[i])
        end
        storage ./= norm(storage)
        return storage
    end

    settings = Boscia.create_default_settings()
    settings.branch_and_bound[:verbose] = true
    x, _, result = Boscia.solve(f, grad!, blmo, settings=settings)
    #@show x
    @show result[:raw_solution]
    @test f(x) <= f(result[:raw_solution]) + 1e-6
    @test sum(x[p+1:2p]) <= k
end